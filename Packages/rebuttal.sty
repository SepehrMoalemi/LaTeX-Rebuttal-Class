% Required packages
\RequirePackage{tcolorbox}
\RequirePackage{etoolbox}
\RequirePackage{xparse}
\RequirePackage{csquotes}
\RequirePackage{needspace}
\RequirePackage{pdfpages}
\RequirePackage{lastpage}

\tcbuselibrary{breakable}

% Define the colors for the comments
\colorlet{ReviewColBackDefault}{blue!7!white}
\colorlet{ReviewColFrameDefault}{blue!50!white}
\colorlet{ReviewColBackResolved}{green!7!white}
\colorlet{ReviewColFrameResolved}{green!80!black}
\colorlet{ReviewColBackPending}{orange!7!white}
\colorlet{ReviewColFramePending}{orange!50!white}
\colorlet{ReviewColBackStuck}{red!7!white}
\colorlet{ReviewColFrameStuck}{red!50!white}

% Define a counter for review comments
\newcounter{reviewcommentcounter}
\newcounter{NumberOfComments}
\newcounter{NumberOfResolved}
\newcounter{NumberOfPending}
\newcounter{NumberOfStuck}

% Reset the counter at the beginning of each section
\pretocmd{\section}{\setcounter{reviewcommentcounter}{0}}{}{}

% Define the rebuttal environment that uses two separate boxes
\NewDocumentEnvironment{rebuttal}{O{} +m +m}{%
    % Begin code: Comment Box
    % \needspace{10\baselineskip}
    \stepcounter{reviewcommentcounter}%
    \stepcounter{NumberOfComments}%

    % Initialize colors to default (blue)
    \def\ReviewColBack{ReviewColBackDefault}%
    \def\ReviewColFrame{ReviewColFrameDefault}%
    % Check optional argument and set colors accordingly
    \ifstrempty{#1}{}{%
        \ifstrequal{#1}{resolved}{%
            \stepcounter{NumberOfResolved}%
            \def\ReviewColBack{ReviewColBackResolved}%
            \def\ReviewColFrame{ReviewColFrameResolved}%
        }{%
            \ifstrequal{#1}{pending}{%
                \stepcounter{NumberOfPending}%
                \def\ReviewColBack{ReviewColBackPending}%
                \def\ReviewColFrame{ReviewColFramePending}%
            }{%
                \ifstrequal{#1}{stuck}{%
                    \stepcounter{NumberOfStuck}%
                    \def\ReviewColBack{ReviewColBackStuck}%
                    \def\ReviewColFrame{ReviewColFrameStuck}%
                }{%
                    % If none of the above, keep default colors (blue)
                }%
            }%
        }%
    }%
    % Now, begin the tcolorbox with the determined colors
    \begin{tcolorbox}[%
        title=Comment~\thereviewcommentcounter, 
        colback=\ReviewColBack,
        colframe=\ReviewColFrame,
        bottomrule=0mm,
        toprule=0mm,
        rightrule=0mm,
        arc=0mm,
        leftrule=0.3mm,
        left=1mm,
        right=1mm,
        top=1mm,
        bottom=3mm,
        fonttitle=\bfseries\color{black},
        width=\textwidth,
        after=\vspace{-\baselineskip} % Remove spacing after the comment box
    ]%
        #2 % Content of the comment
    \end{tcolorbox}%
    % Begin code: Response Box
    % \begin{tcolorbox}[
    %     colframe=\ReviewColFrame, % Frame color same as the comment
    %     colback=white, % Background color for the response
    %     bottomrule=0.1mm,
    %     toprule=0mm,
    %     rightrule=0mm,
    %     arc=0mm,
    %     leftrule=0.3mm,
    %     left=1mm,
    %     right=1mm,
    %     top=3mm,
    %     bottom=1mm,
    %     breakable,
    %     fonttitle=\bfseries\color{black},
    %     width=\textwidth,
    %     before upper={\textbf{Response:} \par\setlength{\parskip}{3pt}}
    % ]
    % #3 % Content of the response
}
{
    % End code
    % \end{tcolorbox}
}

% Define a command to print the statistics of the rebuttal
\newcommand{\printStats}{
    \newpage
    \thispagestyle{empty}
    \newcount\unanswered
    \unanswered=\numexpr\theNumberOfComments-\theNumberOfResolved-\theNumberOfPending-\theNumberOfStuck\relax
    \begin{center}\Large
        \begin{tabular}{|c|}
            \hline\hline
            \textcolor{black}{Total Number of Comments: \theNumberOfComments} \\%
            \textcolor{ReviewColFrameDefault}{Not Responded: \the\unanswered} \\%
            \textcolor{ReviewColFrameResolved}{Easy Response: \theNumberOfResolved} \\%
            \textcolor{ReviewColFramePending}{Minor Revision: \theNumberOfPending} \\%
            \textcolor{ReviewColFrameStuck}{Major Revision: \theNumberOfStuck} \\%
            \hline\hline
        \end{tabular}
    \end{center}
}